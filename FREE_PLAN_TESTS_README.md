# اختبارات منطق الباقات المجانية (Free Plan Logic Tests)

## نظرة عامة
هذه الاختبارات تتحقق من صحة المنطق الجديد المضاف لإنشاء الإعلانات عندما يكون سعر الباقة = 0

## السيناريوهات المختبرة

### 1️⃣ قبول الإعلان عندما سعر الباقة = 0
**الهدف:** التحقق من أن الإعلان يُقبل مباشرة بدون التحقق من الرصيد أو الباقات عندما يكون سعر الباقة = 0

**الخطوات:**
- إنشاء قسم بسعر باقة standard = 0
- محاولة إنشاء إعلان standard بدون باقة أو رصيد
- التحقق من قبول الإعلان بنجاح
- التحقق من أن نوع الدفع = `free_plan`
- التحقق من أن السعر = 0

**النتيجة المتوقعة:** ✅ الإعلان يُقبل مباشرة

---

### 2️⃣ قبول الإعلان المميز عندما سعره = 0
**الهدف:** التحقق من أن الإعلانات المميزة (featured) تُقبل عندما سعرها = 0

**الخطوات:**
- إنشاء قسم بسعر باقة featured = 0
- محاولة إنشاء إعلان featured بدون باقة
- التحقق من قبول الإعلان

**النتيجة المتوقعة:** ✅ الإعلان المميز يُقبل مباشرة

---

### 3️⃣ طلب الدفع عندما السعر > 0 وبدون باقة
**الهدف:** التحقق من أن النظام يطلب الدفع عندما يكون السعر > 0 والمستخدم ليس لديه باقة

**الخطوات:**
- إنشاء قسم بسعر باقة standard = 50
- محاولة إنشاء إعلان بدون باقة
- التحقق من رفض الإعلان
- التحقق من طلب الدفع (status code 402)

**النتيجة المتوقعة:** ❌ رفض الإعلان وطلب الدفع

---

### 4️⃣ قبول الإعلان عندما المستخدم لديه رصيد في الباقة
**الهدف:** التحقق من أن النظام يستهلك من الباقة عندما يكون لدى المستخدم رصيد

**الخطوات:**
- إنشاء قسم بسعر باقة standard = 50
- إنشاء باقة للمستخدم برصيد 5 إعلانات
- محاولة إنشاء إعلان
- التحقق من قبول الإعلان
- التحقق من خصم إعلان واحد من الرصيد

**النتيجة المتوقعة:** ✅ الإعلان يُقبل ويتم خصم من الرصيد

---

### 5️⃣ طلب الدفع عندما رصيد الباقة = 0
**الهدف:** التحقق من أن النظام يطلب الدفع عندما ينفد رصيد الباقة

**الخطوات:**
- إنشاء قسم بسعر باقة standard = 50
- إنشاء باقة للمستخدم برصيد منتهي (5/5 مستخدم)
- محاولة إنشاء إعلان
- التحقق من رفض الإعلان وطلب الدفع

**النتيجة المتوقعة:** ❌ رفض الإعلان وطلب الدفع

---

### 6️⃣ الأدمن يمكنه إنشاء إعلانات بدون قيود
**الهدف:** التحقق من أن الأدمن يمكنه إنشاء إعلانات بغض النظر عن السعر أو الرصيد

**الخطوات:**
- إنشاء قسم بسعر باقة standard = 100
- تسجيل دخول كأدمن
- محاولة إنشاء إعلان بدون باقة
- التحقق من قبول الإعلان
- التحقق من أن نوع الدفع = `admin_bypass`

**النتيجة المتوقعة:** ✅ الإعلان يُقبل مباشرة

---

## كيفية تشغيل الاختبارات

### على Windows:
```bash
# الطريقة 1: استخدام الملف الدفعي
run_free_plan_tests.bat

# الطريقة 2: من سطر الأوامر
cd nas-masr
php artisan test --filter=ListingCreationWithFreePlanTest
```

### على Linux/Mac:
```bash
cd nas-masr
php artisan test --filter=ListingCreationWithFreePlanTest
```

### تشغيل اختبار واحد فقط:
```bash
php artisan test --filter=test_ad_accepted_when_plan_price_is_zero
```

---

## المتطلبات
- PHP >= 8.1
- Laravel >= 10.x
- قاعدة بيانات مهيأة للاختبارات
- Composer dependencies مثبتة

---

## ملاحظات مهمة

1. **RefreshDatabase:** الاختبارات تستخدم `RefreshDatabase` trait لضمان بيئة نظيفة لكل اختبار

2. **Sanctum Authentication:** الاختبارات تستخدم Laravel Sanctum للمصادقة

3. **Database Seeding:** الاختبارات تنشئ البيانات المطلوبة تلقائياً (users, categories, etc.)

4. **Isolation:** كل اختبار مستقل ولا يؤثر على الآخر

---

## ترتيب الأولويات في المنطق الجديد

```
عند إنشاء إعلان مدفوع (standard أو featured):

0. هل سعر الباقة = 0؟
   ✅ نعم → قبول مباشر (free_plan)
   ❌ لا → انتقل للخطوة التالية

1. هل لدى المستخدم باقة برصيد كافٍ؟
   ✅ نعم → خصم من الباقة وقبول
   ❌ لا → انتقل للخطوة التالية

2. هل لدى المستخدم اشتراك قديم فعّال؟
   ✅ نعم → قبول
   ❌ لا → انتقل للخطوة التالية

3. هل المستخدم أدمن؟
   ✅ نعم → قبول (admin_bypass)
   ❌ لا → طلب الدفع الفردي
```

---

## التحقق من النتائج

بعد تشغيل الاختبارات، يجب أن ترى:

```
✅ Test 1 Passed: Ad accepted when plan price is 0
✅ Test 2 Passed: Featured ad accepted when price is 0
✅ Test 3 Passed: Payment required when price > 0 and no package
✅ Test 4 Passed: Ad accepted when user has package balance
✅ Test 5 Passed: Payment required when package balance is 0
✅ Test 6 Passed: Admin can create ad without restrictions

Tests:  6 passed
Time:   X.XXs
```

---

## استكشاف الأخطاء

### خطأ: "Class 'Database\Factories\CategoryFactory' not found"
**الحل:** تأكد من وجود ملف `CategoryFactory.php` في مجلد `database/factories`

### خطأ: "SQLSTATE[HY000]: General error: 1 no such table"
**الحل:** قم بتشغيل migrations:
```bash
php artisan migrate --env=testing
```

### خطأ: "Target class [ListingController] does not exist"
**الحل:** تأكد من أن جميع الـ dependencies مثبتة:
```bash
composer install
```

---

## الملفات المعدلة

1. `app/Http/Controllers/ListingController.php` - إضافة منطق السعر = 0
2. `app/Models/Category.php` - إضافة HasFactory trait
3. `database/factories/CategoryFactory.php` - إنشاء factory جديد
4. `tests/Feature/ListingCreationWithFreePlanTest.php` - الاختبارات الشاملة

---

## الخلاصة

هذه الاختبارات تضمن أن المنطق الجديد يعمل بشكل صحيح في جميع السيناريوهات الممكنة، وتوفر حماية ضد أي تغييرات مستقبلية قد تكسر هذه الوظيفة.
