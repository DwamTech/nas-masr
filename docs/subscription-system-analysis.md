# ุชุญููู ูููุงุฑูุฉ ูุธุงู ุงูุงุดุชุฑุงูุงุช ูุงูุจุงูุงุช

## ๐ ุงููุธุงู ุงูุญุงูู (Current System)

### 1. ูุธุงููู ูููุตููู ููุฅุฏุงุฑุฉ

#### ุฃ) ุฌุฏูู `user_plan_subscriptions` (ุงุดุชุฑุงู ุญุณุจ ุงููุณู)
| ุงูุญูู | ุงููุตู |
|-------|-------|
| `user_id` | ุงููุณุชุฎุฏู |
| `category_id` | **ูุณู ูุงุญุฏ ููุท** |
| `plan_type` | featured ุฃู standard |
| `ads_total` / `ads_used` | ุนุฏุฏ ุงูุฅุนูุงูุงุช ุงูููู ูุงููุณุชุฎุฏู |
| `days` / `expires_at` | ูุฏุฉ ุงูุตูุงุญูุฉ |

**ุฎุตุงุฆุต:**
- ูู ุณุทุฑ = ุงุดุชุฑุงู ููุณู ูุงุญุฏ ููุท
- ูู ุงููุณุชุฎุฏู ุนุงูุฒ ูุดุชุฑู ูู 3 ุฃูุณุงู = 3 ุณุทูุฑ ูููุตูุฉ
- ุงูุฃุฏูู ููุฏุฑ ูุถูู ุงุดุชุฑุงู ุนุจุฑ `UserSubscriptionsController`

#### ุจ) ุฌุฏูู `user_packages` (ุจุงูุฉ ุนุงูุฉ)
| ุงูุญูู | ุงููุตู |
|-------|-------|
| `featured_ads` / `featured_ads_used` | ุฅุนูุงูุงุช ูุชููุฒุฉ |
| `standard_ads` / `standard_ads_used` | ุฅุนูุงูุงุช ุณุชุงูุฏุฑุฏ |
| `featured_expire_date` / `standard_expire_date` | ุงูุชูุงุก ูู ููุน |

**ุฎุตุงุฆุต:**
- ุจุงูุฉ ุนุงูุฉ: ุชุตูุญ ููู ุงูุฃูุณุงู
- ูููุด ุชุญุฏูุฏ ุฃูุณุงู ูุนููุฉ

---

### 2. ููุทู ุฅูุดุงุก ุงูุฅุนูุงู (`ListingController.store`)

```
1. ูู plan_type != free:
   โโโ ุดูู ุนูู UserPlanSubscription (ุงูุงุดุชุฑุงู ุญุณุจ ุงููุณู)
   โ   โโโ ูู ููุฌูุฏ ููุดุท โ ุฎุตู ุฅุนูุงู ูุงุญุฏ โ
   โ
   โโโ ูู ูููุด ุงุดุชุฑุงู โ ุดูู ุนูู UserPackages (ุงูุจุงูุฉ ุงูุนุงูุฉ)
   โ   โโโ ูู ููุฌูุฏุฉ ููุดุทุฉ โ ุฎุตู ูู featured_ads ุฃู standard_ads โ
   โ
   โโโ ูู ูููุด ุจุงูุฉ โ payment_required = true โ

2. ูู plan_type == free:
   โโโ ุดูู ุนูู ุนุฏุฏ ุงูุฅุนูุงูุงุช ุงููุฌุงููุฉ ูุงูุญุฏ ุงูุฃูุตู ููุณุนุฑ
```

---

## ๐ฏ ุงูุณููุงุฑูู ุงููุทููุจ (Requested System)

```
ุงููุณุชุฎุฏู ูุทูุจ ุงุดุชุฑุงู (ูุญุฏุฏ ุงููุณู)
        โ
ูุฏูุน ููุจุนุช ุฅุซุจุงุช ุนูู ูุงุชุณุงุจ
        โ
ุงูุฃุฏูู ูุนูู ุงูุจุงูุฉ ูููุณุชุฎุฏู
        โ
ุงููุณุชุฎุฏู ูุถูู ุฅุนูุงู
        โ
    โโโโโโโโโโโโโโโโโโโโโ
    โ ูุณู ูุณููุญุ       โ
    โโโโโโโโโโโโโโโโโโโโโ
         /          \
       ูุนู          ูุง
        โ            โ
   ูุนุฏู ุนุงุฏู โ   ุชุญููู ููุฏูุน ๐ณ
```

**ุงููุทููุจ:**
1. ุงุดุชุฑุงู ูุงุญุฏ ูุฏุนู **ุฃูุณุงู ูุชุนุฏุฏุฉ**
2. ุงูุฃุฏูู ูุนูู: ุนุฏุฏ ุงูุฅุนูุงูุงุช + ุงููุฏุฉ + **ุงูุฃูุณุงู ุงููุณููุญุฉ**
3. ุนูุฏ ุฅุถุงูุฉ ุฅุนูุงู:
   - ูุณู ูุณููุญ โ ูุฎุตู ูู ุงูุฑุตูุฏ
   - ูุณู ุบูุฑ ูุณููุญ โ ููุทูุจ ุฏูุน

---

## ๐ ุงูุงุฎุชูุงูุงุช ุงูุฌููุฑูุฉ

| ุงูููุทุฉ | ุงููุธุงู ุงูุญุงูู | ุงููุทููุจ |
|--------|---------------|---------|
| **ุงูุฃูุณุงู** | ูุณู ูุงุญุฏ ููู ุงุดุชุฑุงู | **ุฃูุณุงู ูุชุนุฏุฏุฉ ูู ุงุดุชุฑุงู ูุงุญุฏ** |
| **ูุธุงู ุงูุจุงูุงุช** | ูุธุงููู ูููุตููู (subscription + package) | ูุธุงู ููุญุฏ |
| **ุงูุชุญูู ุนูุฏ ุฅุถุงูุฉ ุฅุนูุงู** | ููุท ูุดูู ุนูู ุงูุฑุตูุฏ | ูุดูู ุนูู **ุงููุณู + ุงูุฑุตูุฏ** |
| **ุงูุชุญููู ููุฏูุน** | ูุฑุฌุน ุฑุณุงูุฉ ุฎุทุฃ | ูุญูู ูุตูุญุฉ ุงูุฏูุน (ููุฅุนูุงู ุงููุงุญุฏ) |

---

## ๐ ุฎุทุฉ ุงูุชูููุฐ ุงูููุชุฑุญุฉ

### ุงููุฑุญูุฉ 1: ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### Migration ูุฅุถุงูุฉ ุญูู ุงูุฃูุณุงู ุงููุชุนุฏุฏุฉ

```php
// ุฅุถุงูุฉ ุญูู category_ids ุจุฏูุงู ูู category_id
$table->json('category_ids')->nullable(); // ูุซุงู: [1, 3, 5]
```

> โ๏ธ **ุชุญุฐูุฑ:** ูุฌุจ ุงูุญูุงุธ ุนูู `category_id` ุงูุญุงูู ููู backward compatibility ุซู ุนูู migration ูููู ุงูุจูุงูุงุช.

---

### ุงููุฑุญูุฉ 2: ุชุนุฏูู ุงูููุฏูู

#### ุชุนุฏูู `app/Models/UserPlanSubscription.php`

```php
protected $casts = [
    'category_ids' => 'array', // NEW
    // ...
];

// ุฏุงูุฉ ุฌุฏูุฏุฉ ููุชุญูู ูู ุงููุณู
public function allowsCategory(int $categoryId): bool
{
    // ูู ูุงุถู = ูู ุงูุฃูุณุงู ูุณููุญุฉ
    if (empty($this->category_ids)) {
        return true;
    }
    return in_array($categoryId, $this->category_ids);
}
```

---

### ุงููุฑุญูุฉ 3: ุชุนุฏูู ููุทู ุฅูุดุงุก ุงูุฅุนูุงู

#### ุชุนุฏูู `app/Http/Controllers/ListingController.php` - ุฏุงูุฉ `store`

```php
// ุจุฏูุงู ูู:
$activeSub = UserPlanSubscription::query()
    ->where('category_id', $sec->id()) // ูุณู ูุงุญุฏ
    // ...

// ูุณุชุฎุฏู:
$activeSub = UserPlanSubscription::query()
    ->where('user_id', $user->id)
    ->where('plan_type', $planNorm)
    ->where('payment_status', 'paid')
    ->where(function ($q) {
        $q->whereNull('expires_at')->orWhere('expires_at', '>=', now());
    })
    ->whereRaw('ads_used < ads_total')
    ->get()
    ->first(function ($sub) use ($sec) {
        return $sub->allowsCategory($sec->id());
    });

// ูู ูููุด ุงุดุชุฑุงู ูุณูุญ ุจุงููุณู ุฏู
if (!$activeSub) {
    // ุดูู ูู ุนูุฏู ุงุดุชุฑุงู ูุดุท ุจุณ ูุด ูููุณู ุฏู
    $hasActiveButNotAllowed = UserPlanSubscription::query()
        ->where('user_id', $user->id)
        ->where('plan_type', $planNorm)
        ->where('payment_status', 'paid')
        ->where(function ($q) {
            $q->whereNull('expires_at')->orWhere('expires_at', '>=', now());
        })
        ->whereRaw('ads_used < ads_total')
        ->exists();
    
    if ($hasActiveButNotAllowed) {
        // ุนูุฏู ุงุดุชุฑุงู ุจุณ ูุด ูููุณู ุฏู โ ููุทูุจ ุฏูุน ููุฅุนูุงู ุงููุงุญุฏ
        return response()->json([
            'success' => false,
            'message' => 'ูุฐุง ุงููุณู ุบูุฑ ูุดููู ูู ุงุดุชุฑุงูู ุงูุญุงูู. ููููู ุฏูุน ูููุฉ ุงูุฅุนูุงู ุงููุงุญุฏ.',
            'payment_required' => true,
            'payment_type' => 'single_ad',
            'redirect_to' => '/payment/single-ad',
        ], 402);
    }
}
```

---

### ุงููุฑุญูุฉ 4: ุชุนุฏูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

#### ุชุนุฏูู `app/Http/Controllers/Admin/UserSubscriptionsController.php` - ุฏุงูุฉ `store`

```php
$data = $request->validate([
    'user_id' => ['required', 'integer', 'exists:users,id'],
    'category_ids' => ['nullable', 'array'], // NEW: ุฃูุณุงู ูุชุนุฏุฏุฉ
    'category_ids.*' => ['integer', 'exists:categories,id'],
    'plan_type' => ['required', 'string', Rule::in(['featured', 'standard'])],
    'ads_total' => ['required', 'integer', 'min:0'],
    'days' => ['nullable', 'integer', 'min:0'],
    // ...
]);
```

---

## โ ุฎุทุฉ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุฏูู
1. **ุฅูุดุงุก ุงุดุชุฑุงู ุจุฃูุณุงู ูุชุนุฏุฏุฉ**: ูู ุงูุฏุงุดุจูุฑุฏุ ุงุฎุชุฑ ูุณุชุฎุฏู ูุญุฏุฏ ูุณููู ูุซูุงู (ุนูุงุฑุงุช + ุณูุงุฑุงุช)
2. **ุฅุถุงูุฉ ุฅุนูุงู ูู ูุณู ูุณููุญ**: ูุฌุจ ุฃู ูุนุฏู ุจูุฌุงุญ
3. **ุฅุถุงูุฉ ุฅุนูุงู ูู ูุณู ุบูุฑ ูุณููุญ**: ูุฌุจ ุฃู ูุธูุฑ ุฑุณุงูุฉ ุชุญููู ููุฏูุน

---

## โ๏ธ ุฃุณุฆูุฉ ูููุฉ ุชุญุชุงุฌ ุฅุฌุงุจุฉ ูุจู ุงูุจุฏุก

### 1. ูู ููุญุฏ ูุธุงู ุงูุจุงูุงุชุ
ุญุงููุงู ุนูุฏู ูุธุงููู:
- `user_plan_subscriptions` (ุงุดุชุฑุงู ุญุณุจ ุงููุณู)
- `user_packages` (ุจุงูุฉ ุนุงูุฉ)

**ุงูุณุคุงู**: ูู ูุณุชูุฑ ุจุงููุธุงููู ุฃู ููุญุฏูู ูู ูุธุงู ูุงุญุฏุ
ุงูุชูุญูุฏ ุฃูุถู ูููุณุชูุจู ููู ูุญุชุงุฌ ุฌูุฏ ุฃูุจุฑ.

### 2. ูุงุฐุง ูุญุตู ููุจุงูุฉ ุงูุนุงูุฉ (`user_packages`)ุ
ุญุงููุงู ูู ุงููุณุชุฎุฏู ูุนูุฏูุด ุงุดุชุฑุงูุ ุงููุธุงู ุจูุดูู ุนูู ุงูุจุงูุฉ ุงูุนุงูุฉ.
**ุงูุณุคุงู**: ูู ูุญุชูุธ ุจูุฐุง ุงูุณููู ุฃู ููุบููุ

### 3. ุงูุชุญูู ูู ุงูุฏูุน ููุฅุนูุงู ุงููุงุญุฏ
ุงูุณููุงุฑูู ูููู "ูุชู ุชุญูููู ูุตูุญุฉ ุงูุฏูุน ููุฏูุน ุซูู ุงูุฅุนูุงู ุงููุงุญุฏ".
**ุงูุณุคุงู**: ูู ุนูุฏู ุญุงููุงู ูุธุงู ุฏูุน ููุฅุนูุงู ุงููุงุญุฏ (ูุซู ุจูุงุจุฉ ุฏูุน ุฅููุชุฑููู) ุฃู ุงูุฏูุน ูู ุฎูุงู ุงูุชุญููู ุงููุฏูู + ูุงุชุณุงุจ ููุทุ

---

## ๐ ููุฎุต ุงูููุงู

- [ ] ุฅุถุงูุฉ ุญูู `category_ids` ููุฌุฏูู `user_plan_subscriptions`
- [ ] ุชุนุฏูู ููุฏูู `UserPlanSubscription` ูุฏุนู ุงูุฃูุณุงู ุงููุชุนุฏุฏุฉ
- [ ] ุชุนุฏูู `ListingController.store` ููุชุญูู ูู ุงููุณู ุงููุณููุญ
- [ ] ุชุนุฏูู `UserSubscriptionsController.store` ููุจูู ุฃูุณุงู ูุชุนุฏุฏุฉ
- [ ] ุชุญุฏูุซ ุงูู Dashboard ูุฏุนู ุงุฎุชูุงุฑ ุฃูุณุงู ูุชุนุฏุฏุฉ
- [ ] (ุงุฎุชูุงุฑู) ุชูุญูุฏ ูุธุงูู ุงูุจุงูุงุช
