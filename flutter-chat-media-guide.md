# ุฏููู ุชุทููุฑ ุงูุดุงุช (Flutter) - ุฏุนู ุงููุณุงุฆุท (Media Support)

ูุฐุง ุงูุฏููู ูุฎุตุต ููุทูุฑ ุงูููุงุชุฑ ูุชูููุฐ ุฎุงุตูุฉ ุฅุฑุณุงู (ูุตูุตุ ุตูุฑุ ููุฏููุ ุชุณุฌูู ุตูุชู) ุจุดูู ุงุญุชุฑุงูู ูุฎุงูู ูู ุงูุฃุฎุทุงุก.

---

## ๐ 1. ุงูู Endpoints ูุงูุฑุฏูุฏ ุงููุชููุนุฉ (API & Responses)

ุงูุฑุงุจุท ุงูุฃุณุงุณู ููุฅุฑุณุงู ูู: `POST /api/chat/send`
**ููุน ุงูุทูุจ:** `Multipart/Form-Data` (ุถุฑูุฑู ุฌุฏุงู ูุฏุนู ุงููููุงุช)

### ุฃ. ุฅุฑุณุงู ุฑุณุงูุฉ ูุตูุฉ (Text Message)
ุฑุณุงูุฉ ุนุงุฏูุฉ ุจุฏูู ูุฑููุงุช.

**Request Body:**
```dart
FormData.fromMap({
  "receiver_id": 10,
  "message": "ุงูุณูุงู ุนููููุ ููู ุงูุญุงูุ",
  "content_type": "text"
});
```

### ุจ. ุฅุฑุณุงู ุตูุฑุฉ (Image)
ุฅุฑุณุงู ุตูุฑุฉ ูุน ุฃู ุจุฏูู ุชุนููู (Caption).

**Request Body:**
```dart
FormData.fromMap({
  "receiver_id": 10,
  "content_type": "image",
  "file": await MultipartFile.fromFile(imagePath, filename: 'image.jpg'),
  "message": "ุตูุฑุฉ ุงูููุชุฌ" // ุงุฎุชูุงุฑู (Caption)
});
```

### ุฌ. ุฅุฑุณุงู ุชุณุฌูู ุตูุชู (Audio Record)
**Request Body:**
```dart
FormData.fromMap({
  "receiver_id": 10,
  "content_type": "audio",
  "file": await MultipartFile.fromFile(audioPath, filename: 'record.m4a'),
});
```

### ุฏ. ุฅุฑุณุงู ููุฏูู (Video)
**Request Body:**
```dart
FormData.fromMap({
  "receiver_id": 10,
  "content_type": "video",
  "file": await MultipartFile.fromFile(videoPath, filename: 'video.mp4'),
  "message": "ููุฏูู ุชูุถูุญู" // ุงุฎุชูุงุฑู
});
```

---

## ๐ฆ ุดูู ุงูุฑุฏ (Response Structure)

ุงูู Backend ููุญุฏ ูู ุงูุฑุฏุ ููุง ูุณูู ุนููู ุนูู Parsing (Model `ChatMessage`).

**ูุซุงู ูุฑุฏ ูุงุฌุญ (Success 201):**
```json
{
    "message": "ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ",
    "data": {
        "id": 125,
        "conversation_id": "peer:10:5",
        "message": "ุตูุฑุฉ ุงูููุชุฌ",  // ุงููุต ุงููุฑูู (ุฃู null)
        "attachment": "https://domain.com/storage/chat/2025/12/images/xyz.jpg", // ุฑุงุจุท ุงูููู (ุฃู null)
        "content_type": "image", // (text, image, video, audio, listing_inquiry)
        "created_at": "2025-12-14T23:30:00.000000Z"
    }
}
```

---

## ๐๏ธ 2. ููุทู ุงูุงุณุชุฎุฏุงู ูุงูุชูููุฐ (Implementation Logic)

### ุฃ. ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช (Permissions)
ูุจู ูุชุญ ุงููุงููุฑุง ุฃู ุงููุงููุ ุชุฃูุฏ ูู ุทูุจ ุงูุตูุงุญูุงุช ุจุงุณุชุฎุฏุงู `permission_handler`:
*   `Permission.microphone` (ููุชุณุฌูู)
*   `Permission.camera` & `Permission.photos` (ููุตูุฑ ูุงูููุฏูู)
*   ุฅุฐุง ุฑูุถ ุงููุณุชุฎุฏูุ ุฃุธูุฑ Dialog ูุดุฑุญ ูู: "ูุญุชุงุฌ ุงูุตูุงุญูุฉ ูุฅุฑุณุงู ุงูุชุณุฌูู ุงูุตูุชู".

### ุจ. ุถุบุท ุงููููุงุช (Compression) - **ููู ุฌุฏุงู**
ูุง ุชุฑุณู ุงููููุงุช ุจุฃุญุฌุงููุง ุงูุฃุตููุฉ ุฃุจุฏุงู.
1.  **ุงูุตูุฑ:** ุงุณุชุฎุฏู `flutter_image_compress` ูุถุบุท ุงูุตูุฑุฉ ูุจู ุงูุฑูุน (ูุซูุงู quality: 70).
2.  **ุงูููุฏูู:** ุงุณุชุฎุฏู `video_compress` ูุชูููู ุงูุญุฌู ูุน ุงูุญูุงุธ ุนูู ุงูุฌูุฏุฉ ุงูููุจููุฉ.

### ุฌ. ุญุงูุฉ ุงูุฑูุน (Upload Progress)
ุงุณุชุฎุฏู `onSendProgress` ุงูููุฌูุฏ ูู `Dio` ูุฅุธูุงุฑ ุดุฑูุท ุชูุฏู ุญูููู ูููุณุชุฎุฏูุ ุฎุงุตุฉ ูุน ุงูููุฏูู.

```dart
dio.post(
  '/api/chat/send',
  data: formData,
  onSendProgress: (int sent, int total) {
    // ุชุญุฏูุซ ุดุฑูุท ุงูุชุญููู (CircularProgressIndicator)
    print("$sent / $total");
  },
);
```

---

## โ๏ธ 3. ููุฏูุฉ ุงูุฃุฎุทุงุก (Error Handling)

ููุฏ ููุช ุจุถุจุท ุงูู Backend ููุนูุฏ ุฑุณุงุฆู ุฎุทุฃ ุนุฑุจูุฉ ูุงุถุญุฉ (Validation Errors) ูู ุญุงูุฉ ุงููุดู.

**ููู ุชูุฑุฃ ุงูุฎุทุฃุ**
ุฅุฐุง ุนุงุฏ ุงูู API ุจู `Status 422`:
ุงูุฑุฃ ุงูู JSONุ ุณุชุฌุฏ ูุตูููุฉ `errors`. ุงุนุฑุถ **ุฃูู ุฑุณุงูุฉ** ูููุณุชุฎุฏู ูู `Toast` ุฃู `Snackbar`.

**ุฃูุซูุฉ ูุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงุฏูุฉ ูู ุงูุณูุฑูุฑ:**
*   "ุญุฌู ุงูููู ูุจูุฑ ุฌุฏุงู (ูุฌุจ ุฃู ูููู ุฃูู ูู 5 ููุฌุงุจุงูุช ููุตูุฑ)"
*   "ููุน ุงูููู ุบูุฑ ูุฏุนูู"
*   "ูุฌุจ ูุชุงุจุฉ ุฑุณุงูุฉ ุฃู ุฅุฑูุงู ููู"

**ูุตูุญุฉ:** ูุง ุชุนุฑุถ ูููุฉ "Server Error" ุฃู ุฃููุงุฏ ุชูููุฉ. ุงุนุฑุถ ุฑุณุงูุฉ ุงูู Backend ูุจุงุดุฑุฉ ูุฃููุง ูููุฆุฉ ูููุณุชุฎุฏู ุงูููุงุฆู.

---

## ๐ก 4. ูุตุงุฆุญ ูุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฐููุฉ (UX Tips)

1.  **ุงููุนุงููุงุช ุงููุญููุฉ (Local Previews):**
    *   ุนูุฏ ุงุฎุชูุงุฑ ุตูุฑุฉุ ุงุนุฑุถูุง ููุฑุงู ูู ุงูุดุงุช (ุจุงูุชุฉ) ูุจู ุฃู ููุชูู ุงูุฑูุน.
    *   ุจูุฌุฑุฏ ูุฌุงุญ ุงูู APIุ ุญูููุง ููุญุงูุฉ ุงูุทุจูุนูุฉ.

2.  **ูุดุบู ุงูุตูุช (Audio Player):**
    *   ูุง ุชุณุชุฎุฏู ุงููุดุบู ุงูุงูุชุฑุงุถู ูููุธุงู. ุงุณุชุฎุฏู ููุชุจุฉ ูุซู `just_audio` ูุน ุชุตููู Waveform ุจุณูุท.
    *   ุฃุถู ุฒุฑ ุชุดุบูู/ุฅููุงู ูุงุถุญ.

3.  **ุฅูุบุงุก ุงูุฑูุน:**
    *   ุฃุซูุงุก ุฑูุน ููุฏูู ูุจูุฑุ ููุฑ ุฒุฑ "X" ุตุบูุฑ ูุฅูุบุงุก ุงูู API Request (`CancelToken` ูู Dio) ูู ุญุงู ุบูุฑ ุงููุณุชุฎุฏู ุฑุฃูู.

4.  **ุงูุตูุฑ:**
    *   ุงุฌุนู ุงูุตูุฑ ูุงุจูุฉ ููุชูุจูุฑ (Zoomable) ุนูุฏ ุงูุถุบุท ุนูููุง (ุงุณุชุฎุฏู `photo_view`).
    *   ุงุณุชุฎุฏู `CachedNetworkImage` ุฏุงุฆูุงู ูุชุฎุฒูู ุงูุตูุฑ ูุญููุงู ูุนุฏู ุชุญููููุง ูู ูุฑุฉ.

5.  **ูุฏุฎูุงุช ุฐููุฉ (Smart Inputs):**
    *   ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงููุงูู: (ุถุบุทุฉ ูุงุญุฏุฉ = ุจุฏุก ุชุณุฌููุ ุฅููุงุช = ุฅููุงู ูุฅุฑุณุงูุ ุณุญุจ ูููุณุงุฑ = ุฅูุบุงุก). ูุฐุง ูู ุงูู Standard ูู ุชุทุจููุงุช ุงูุดุงุช (ูุงุชุณุงุจุ ุชูููุฌุฑุงู).
